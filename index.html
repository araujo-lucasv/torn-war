<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torn – Perfis (Google Sheets → Shortlist → Status)</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#0b0f14; color:#e6edf3; }
    header { padding: 16px 20px; background: #0f1720; border-bottom: 1px solid #1f2a37; position: sticky; top: 0; z-index: 5; }
    h1 { margin: 0; font-size: 18px; font-weight: 600; }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 16px; padding: 16px; }
    .card { background: #0f1720; border: 1px solid #1f2a37; border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 8px; font-size: 16px; }
    .small { font-size: 12px; color:#9aa7b4; }
    input[type="text"], textarea, select { width: 100%; background:#0b131a; color:#e6edf3; border:1px solid #263241; border-radius: 10px; padding:10px; outline: none; }
    textarea { min-height: 90px; resize: vertical; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .btn { background:#1e88e5; color:white; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#263241; color:#c7d1db; }
    .btn.ghost { background:transparent; border:1px solid #263241; }
    .btn:disabled { opacity: .6; cursor:not-allowed; }
    .list { display:flex; flex-direction: column; gap:8px; max-height: 60vh; overflow:auto; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid #1f2a37; border-radius:12px; background:#0b131a; }
    .item .meta { display:flex; flex-direction:column; }
    .pill { font-size:11px; padding:2px 8px; border:1px solid #263241; border-radius:999px; color:#a9b6c3; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
    .stat { background:#0b131a; border:1px solid #1f2a37; border-radius:12px; padding:10px; }
    .stat h3 { margin:0 0 6px; font-size:14px; }
    .muted { color:#9aa7b4; font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #263241; }
    .danger { color:#ffb4b4; }
    .sticky-actions { position: sticky; bottom: 0; background: linear-gradient(180deg, rgba(15,23,32,0), #0f1720 40%); padding-top: 12px; }
    a { color:#6ab7ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .help { font-size: 12px; color:#8aa0b5; }
    .divider { height: 1px; background:#1f2a37; margin: 8px 0; }
    .loading { font-size: 12px; color: #c7d1db; }
    .toolbar { display:grid; grid-template-columns: 1fr 180px; gap:8px; margin-bottom:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Torn – Importar Perfis da Planilha → Selecionar Destaques → Buscar Status</h1>
  </header>

  <main>
    <!-- Esquerda -->
    <section class="card" style="height: fit-content; align-self: start;">
      <h2>1) Carregar planilha</h2>
      <p class="small">Use um <b>link CSV publicado</b> do Google Sheets (<i>Arquivo → Compartilhar → Publicar na web → CSV</i>) ou cole os dados abaixo.</p>
      <div class="row">
        <input id="csvUrl" type="text" placeholder="URL CSV publicado do Google Sheets (opcional)" />
        <button class="btn" id="btnFetchCsv">Buscar CSV</button>
      </div>
      <div style="height:8px"></div>
      <textarea id="csvText" placeholder="Cabeçalhos esperados: id,member,total&#10;Ex.:&#10;id,member,total&#10;12345,Fulano,123456789&#10;67890,Ciclano,987654321"></textarea>
      <div style="height:8px"></div>
      <div class="row">
        <button class="btn" id="btnParseCsv">Ler CSV</button>
        <button class="btn secondary" id="btnClearCsv">Limpar</button>
      </div>

      <div class="divider"></div>
      <h2>Shortlist (destaques)</h2>
      <p class="help">Marque os perfis na lista da direita para adicioná-los aqui. Remova com “Remover”.</p>
      <div id="shortlist" class="list"></div>

      <div class="sticky-actions">
        <button class="btn" id="btnFetchSelected" disabled>Buscar status dos selecionados</button>
      </div>
    </section>

    <!-- Direita -->
    <section class="card">
      <h2>Perfis da planilha</h2>

      <div class="toolbar">
        <input id="search" type="text" placeholder="Pesquisar por nome ou #id..." />
        <select id="sortMode">
          <option value="total_desc">Ordenar: Total ↓</option>
          <option value="total_asc">Ordenar: Total ↑</option>
          <option value="name_asc">Ordenar: Nome A → Z</option>
          <option value="name_desc">Ordenar: Nome Z → A</option>
        </select>
      </div>

      <div id="profilesList" class="list" style="min-height: 120px;"></div>
      <p class="small" id="profilesCount"></p>

      <div class="divider"></div>
      <h2>Status dos selecionados</h2>
      <div id="results" class="grid"></div>
      <p id="statusMessage" class="loading"></p>
    </section>
  </main>

  <script>
    const API_KEY = "U3pBMJyMyT7n5Dbu"; // <-- chave fixa

    const state = {
      rawRows: [],
      columns: [],
      mappings: { id: null, name: null, total: null },
      profiles: [],
      selectedIds: new Set(),
      searchTerm: '',
      sortMode: 'total_desc',
    };

    // --- CSV robusto ---
    function detectDelimiter(headerLine) { return headerLine.includes(';') ? ';' : ','; }
    function splitCsvLine(line, delim) {
      const out = []; let cur = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (ch === delim && !inQuotes) {
          out.push(cur); cur = '';
        } else { cur += ch; }
      }
      out.push(cur); return out;
    }
    function parseCSV(text) {
      const lines = text.replace(/
/g, '').split('
').filter(l => l.length > 0);
      if (lines.length === 0) return [];
      const delim = detectDelimiter(lines[0]);
      const headers = splitCsvLine(lines[0], delim).map(h => h.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const rawCols = splitCsvLine(lines[i], delim);
        const cols = rawCols.map(v => {
          let val = v.trim();
          if (val.startsWith('"') && val.endsWith('"')) {
            val = val.slice(1, -1).replace(/""/g, '"');
          }
          return val;
        });
        const obj = {};
        headers.forEach((h, idx) => { obj[h] = (cols[idx] ?? '').trim(); });
        rows.push(obj);
      }
      return { headers, rows };
    }

    // refs
    const csvUrl = document.getElementById('csvUrl');
    const csvText = document.getElementById('csvText');
    const btnFetchCsv = document.getElementById('btnFetchCsv');
    const btnParseCsv = document.getElementById('btnParseCsv');
    const btnClearCsv = document.getElementById('btnClearCsv');
    const colId = document.getElementById('colId');
    const colName = document.getElementById('colName');
    const colTotal = document.getElementById('colTotal');
    const btnBuildList = document.getElementById('btnBuildList');
    const profilesList = document.getElementById('profilesList');
    const profilesCount = document.getElementById('profilesCount');
    const shortlist = document.getElementById('shortlist');
    const btnFetchSelected = document.getElementById('btnFetchSelected');
    const results = document.getElementById('results');
    const statusMessage = document.getElementById('statusMessage');
    const search = document.getElementById('search');
    const sortMode = document.getElementById('sortMode');

    // mapping automático
    function fillMappingSelectors(headers) {
      [colId, colName, colTotal].forEach(sel => sel.innerHTML = '');
      for (const h of headers) {
        for (const sel of [colId, colName, colTotal]) {
          const o = document.createElement('option'); o.value = h; o.textContent = h; sel.appendChild(o);
        }
      }
      const idGuess = headers.find(h => /^(id|xid|player_id|userid|user_id)$/i.test(h)) || headers[0];
      const nameGuess = headers.find(h => /^(member|name|nome|player|username|user|nick)$/i.test(h)) || headers[1] || headers[0];
      const totalGuess = headers.find(h => /^(total|stats|total_stats)$/i.test(h)) || headers[2] || headers[0];
      colId.value = idGuess; colName.value = nameGuess; colTotal.value = totalGuess;
      state.mappings.id = idGuess; state.mappings.name = nameGuess; state.mappings.total = totalGuess;
      btnBuildList.disabled = false;
    }

    function normalizeNumber(val){ return Number(String(val).replace(/[.,\s]/g,'')) || 0; }
    function formatNumber(val){ return normalizeNumber(val).toLocaleString('en-US'); }

    function getFilteredSortedProfiles(){
      const q = state.searchTerm.trim().toLowerCase();
      let arr = [...state.profiles];
      if (q) arr = arr.filter(p => (p.name||'').toLowerCase().includes(q) || String(p.id).includes(q));
      switch(state.sortMode){
        case 'total_asc':  arr.sort((a,b)=> normalizeNumber(a.total) - normalizeNumber(b.total)); break;
        case 'name_asc':   arr.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); break;
        case 'name_desc':  arr.sort((a,b)=> (b.name||'').localeCompare(a.name||'')); break;
        case 'total_desc':
        default:           arr.sort((a,b)=> normalizeNumber(b.total) - normalizeNumber(a.total));
      }
      return arr;
    }

    function renderProfiles() {
      profilesList.innerHTML = '';
      const data = getFilteredSortedProfiles();
      for (const p of data) {
        const el = document.createElement('div'); el.className = 'item';
        const left = document.createElement('div'); left.className = 'meta';
        left.innerHTML = `<b>${escapeHtml(p.name||'(sem nome)')}</b> <span class="small">#${p.id}</span>
                          <a href="https://www.torn.com/profiles.php?XID=${p.id}" target="_blank">Abrir perfil</a>
                          <div><span class="pill">Total</span> <span class="small">${formatNumber(p.total)}</span></div>`;
        const right = document.createElement('div');
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = state.selectedIds.has(p.id);
        cb.addEventListener('change', () => { if (cb.checked) { state.selectedIds.add(p.id); addToShortlist(p); }
                                              else { state.selectedIds.delete(p.id); removeFromShortlist(p.id); }
                                              btnFetchSelected.disabled = state.selectedIds.size === 0; });
        right.appendChild(cb);
        el.appendChild(left); el.appendChild(right);
        profilesList.appendChild(el);
      }
      profilesCount.textContent = `${data.length} exibido(s). Total carregado: ${state.profiles.length}.`;
    }

    function addToShortlist(p) {
      if (document.getElementById('short-' + p.id)) return;
      const el = document.createElement('div'); el.className = 'item'; el.id = 'short-' + p.id;
      el.innerHTML = `<div class="meta"><b>${escapeHtml(p.name)}</b> <span class="small">#${p.id}</span>
                      <div class="small">Total: ${formatNumber(p.total)}</div></div>
                      <div><button class="btn ghost">Remover</button></div>`;
      el.querySelector('button').onclick = () => { state.selectedIds.delete(p.id); removeFromShortlist(p.id); renderProfiles(); };
      shortlist.appendChild(el);
    }
    function removeFromShortlist(id){ const el=document.getElementById('short-'+id); if(el) el.remove(); }

    async function fetchTornUser(id) {
      const url = `https://api.torn.com/user/${id}?selections=basic&key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Falha HTTP ${res.status}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error.error);
      return data;
    }

    function renderResultCard(player, data) {
      const c=document.createElement('div'); c.className='stat';
      const lifeCur = Number(data?.life?.current ?? 0);
      const lifeMax = Number(data?.life?.maximum ?? 0);
      const hpPct = (lifeCur && lifeMax) ? Math.round((lifeCur/lifeMax)*100) : 0;
      const hp = lifeMax ? `${lifeCur} / ${lifeMax} (${hpPct}%)` : `${lifeCur} / ${lifeMax}`;
      const stState = data?.status?.state ?? '-';
      const stDesc = data?.status?.description ?? '';
      const laStatus = data?.last_action?.status ?? '-';
      const laRel = data?.last_action?.relative ?? '-';

      c.innerHTML=`<h3>${escapeHtml(player.name)} <span class="muted">#${player.id}</span></h3>
                   <div><span class="badge">Total</span> ${formatNumber(player.total)}</div>
                   <div><span class="badge">Vida</span> ${hp}</div>
                   <div><span class="badge">Status</span> ${escapeHtml(stState)} ${stDesc?`— <span class='muted'>${escapeHtml(stDesc)}</span>`:''}</div>
                   <div><span class="badge">Última ação</span> ${escapeHtml(laStatus)} <span class="muted">(${escapeHtml(laRel)})</span></div>`;
      results.appendChild(c);
    }

    // handlers
    btnFetchCsv.addEventListener('click', async () => {
      const url = csvUrl.value.trim();
      if (!url) { alert('Informe um URL CSV publicado, ou cole os dados.'); return; }
      btnFetchCsv.disabled = true; btnFetchCsv.textContent = 'Baixando...';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        csvText.value = text;
      } catch (e) {
        alert('Falha ao baixar CSV: ' + e.message);
      } finally { btnFetchCsv.disabled = false; btnFetchCsv.textContent = 'Buscar CSV'; }
    });

    btnParseCsv.onclick=()=>{
      const t=csvText.value.trim();
      if(!t) return alert('Cole CSV');
      const p=parseCSV(t);
      if(!p.headers || !p.rows || p.rows.length===0) return alert('CSV vazio ou inválido.');
      state.rawRows=p.rows; fillMappingSelectors(p.headers); alert('CSV carregado! Mapeie as colunas e clique em "Construir lista de perfis".');
    };

    btnClearCsv.onclick=()=>{
      csvText.value=''; profilesList.innerHTML=''; results.innerHTML=''; shortlist.innerHTML='';
      profilesCount.textContent=''; state.rawRows=[]; state.profiles=[]; state.selectedIds.clear();
      btnBuildList.disabled=true; btnFetchSelected.disabled=true; [colId,colName,colTotal].forEach(s=>s.innerHTML='');
      search.value=''; state.searchTerm=''; sortMode.value='total_desc'; state.sortMode='total_desc';
    };

    btnBuildList.onclick=()=>{
      const idKey=state.mappings.id, nameKey=state.mappings.name, totalKey=state.mappings.total;
      if(!idKey||!nameKey||!totalKey) return alert('Selecione as colunas de ID, Nome e Total.');
      state.profiles = state.rawRows.map(r=>({ id:String(r[idKey]).trim(), name:String(r[nameKey]).trim(), total:r[totalKey] }));
      state.selectedIds.clear(); shortlist.innerHTML='';
      renderProfiles(); btnFetchSelected.disabled=true;
    };

    btnFetchSelected.onclick=async()=>{
      const ids=[...state.selectedIds];
      if(ids.length===0) return alert('Selecione ao menos um perfil.');
      results.innerHTML=''; statusMessage.textContent=`Buscando ${ids.length} usuário(s)...`;
      try {
        for (const id of ids) {
          const player = state.profiles.find(p=>p.id===id) || {id, name:'', total:0};
          try { const d = await fetchTornUser(id); renderResultCard(player,d); }
          catch(e){ const err=document.createElement('div'); err.className='stat'; err.innerHTML=`<b>${escapeHtml(player.name)}</b> (#${player.id}) — erro: ${escapeHtml(e.message)}`; results.appendChild(err); }
        }
      } finally { statusMessage.textContent='Concluído.'; }
    };

    search.oninput=()=>{ state.searchTerm=search.value; renderProfiles(); };
    sortMode.onchange=()=>{ state.sortMode=sortMode.value; renderProfiles(); };

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  </script>
</body>
</html>
