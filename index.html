<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torn – Perfis (Google Sheets → Shortlist → Status)</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#0b0f14; color:#e6edf3; }
    header { padding: 16px 20px; background: #0f1720; border-bottom: 1px solid #1f2a37; position: sticky; top: 0; z-index: 5; }
    h1 { margin: 0; font-size: 18px; font-weight: 600; }

    /* layout base */
    main { display: grid; grid-template-columns: 360px 1fr; gap: 16px; padding: 16px; }
    @media (max-width: 900px) { main { grid-template-columns: 1fr; } }

    .card { background: #0f1720; border: 1px solid #1f2a37; border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 8px; font-size: 16px; }
    .small { font-size: 12px; color:#9aa7b4; }
    input[type="text"], textarea, select { width: 100%; background:#0b131a; color:#e6edf3; border:1px solid #263241; border-radius: 10px; padding:10px; outline: none; }
    textarea { min-height: 90px; resize: vertical; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .btn { background:#1e88e5; color:white; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; transition: filter .15s ease; }
    .btn.secondary { background:#263241; color:#c7d1db; }
    .btn.ghost { background:transparent; border:1px solid #263241; color:#c7d1db; }
    .btn:disabled { opacity: .6; cursor:not-allowed; }
    .btn:hover { filter: brightness(1.08); }
    .btn.ghost:hover { border-color:#3b4b5e; }
    .btn.secondary:hover { background:#2b3a49; }

    .list { display:flex; flex-direction: column; gap:8px; max-height: 60vh; overflow:auto; }
    .item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid #1f2a37; border-radius:12px; background:#0b131a; cursor: pointer; }
    .item a, .item input, .item button { cursor: auto; }
    .item .meta { display:flex; flex-direction:column; }
    .pill { font-size:11px; padding:2px 8px; border:1px solid #263241; border-radius:999px; color:#a9b6c3; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
    .stat { background:#0b131a; border:1px solid #1f2a37; border-radius:12px; padding:10px; }
    .stat h3 { margin:0 0 6px; font-size:14px; display:flex; justify-content:space-between; gap:8px; }
    .muted { color:#9aa7b4; font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #263241; }
    .danger { color:#ffb4b4; }
    .sticky-actions { position: sticky; bottom: 0; background: linear-gradient(180deg, rgba(15,23,32,0), #0f1720 40%); padding-top: 12px; }
    a { color:#6ab7ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .help { font-size: 12px; color:#8aa0b5; }
    .divider { height: 1px; background:#1f2a37; margin: 8px 0; }

    /* statusMessage: spinner só quando .is-loading */
    .loading { font-size: 12px; color: #c7d1db; position: relative; padding-left: 26px; }
    .loading::before { content: none; }
    .loading.is-loading::before {
      content: ""; position: absolute; left: 0; top: 50%; width: 16px; height: 16px;
      transform: translateY(-50%); border: 2px solid #263241; border-top-color: #6ab7ff; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }

    .toolbar { display:grid; grid-template-columns: 1fr 180px; gap:8px; margin-bottom:8px;
               position: sticky; top: 0; background: #0f1720; padding-top:8px; padding-bottom:8px; z-index: 4; border-bottom: 1px solid #1f2a37; }

    /* foco acessível */
    .btn:focus, input:focus, select:focus, textarea:focus, a:focus {
      outline: 2px solid #6ab7ff; outline-offset: 2px;
    }

    /* Toggle “Mostrar só status” (sem JS) */
    #compact { display:none; }
    /* quando marcar, esconde a 1ª coluna e expande a 2ª */
    #compact:checked ~ main { grid-template-columns: 0 1fr; }
    #compact:checked ~ main > section:first-child { display: none; }

    /* <details> estilizado (coluna esquerda) */
    details[open] > summary .summary-caret::before { content: "▲ "; }
    details:not([open]) > summary .summary-caret::before { content: "▼ "; }
    summary { cursor:pointer; list-style:none; }
    summary::-webkit-details-marker { display: none; }

    @media (min-width: 1200px) { .grid { gap: 16px; } }
    @media (max-width: 600px) {
      .card { padding: 12px; }
      .item { padding: 8px; }
      .btn { padding: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Torn – Importar Perfis da Planilha → Selecionar Destaques → Buscar Status</h1>
  </header>

  <!-- Toggle global: oculta a coluna esquerda quando marcado (sem JS) -->
  <input type="checkbox" id="compact" hidden />
  <label for="compact" style="display:inline-flex;gap:8px;align-items:center;margin:12px 16px 0;">
    <button class="btn ghost" type="button">⟷</button>
    <span class="small">Mostrar só status</span>
  </label>

  <main>
    <!-- Esquerda -->
    <section class="card" style="height: fit-content; align-self: start;">
      <!-- Acordeão nativo (sem JS) -->
      <details open>
        <summary>
          <h2 style="display:inline">1) Carregar planilha</h2>
          <span class="small summary-caret" style="margin-left:8px">clique para recolher/expandir</span>
        </summary>
        <div style="height:8px"></div>

        <p class="small">Use um <b>link CSV publicado</b> do Google Sheets (<i>Arquivo → Compartilhar → Publicar na web → CSV</i>) ou cole os dados abaixo.</p>
        <div class="row">
          <input id="csvUrl" type="text" placeholder="URL CSV publicado do Google Sheets (opcional)" />
          <button class="btn" id="btnFetchCsv">Buscar CSV</button>
        </div>
        <div style="height:8px"></div>
        <textarea id="csvText" placeholder="Cabeçalhos esperados: id,member,total&#10;Ex.:&#10;id,member,total&#10;12345,Fulano,123456789&#10;67890,Ciclano,987654321"></textarea>
        <div style="height:8px"></div>
        <div class="row">
          <button class="btn" id="btnParseCsv">Ler CSV</button>
          <button class="btn secondary" id="btnClearCsv">Limpar</button>
        </div>

        <div class="divider"></div>
        <h2>2) Mapeie as colunas</h2>
        <div class="cols" style="grid-template-columns: 1fr 1fr 1fr;">
          <div>
            <label class="small">Coluna do <b>ID (XID)</b></label>
            <select id="colId"></select>
          </div>
          <div>
            <label class="small">Coluna do <b>Nome (member)</b></label>
            <select id="colName"></select>
          </div>
          <div>
            <label class="small">Coluna do <b>Total (stats)</b></label>
            <select id="colTotal"></select>
          </div>
        </div>
        <div style="height:8px"></div>
        <button class="btn" id="btnBuildList" disabled>Construir lista de perfis</button>

        <div class="divider"></div>
        <h2>Shortlist (destaques)</h2>
        <p class="help">Marque os perfis na lista da direita para adicioná-los aqui. Remova com “Remover”.</p>
        <div id="shortlist" class="list"></div>

        <div class="divider"></div>
        <h2>Chave da API Torn</h2>
        <input id="apiKey" type="text" value="U3pBMJyMyT7n5Dbu" />
        <p class="help">Campos: <code>life.current</code>, <code>life.maximum</code>, <code>status.state</code>, <code>status.description</code>, <code>last_action.status</code>, <code>last_action.relative</code>.</p>
        <div class="sticky-actions">
          <button class="btn" id="btnFetchSelected" disabled>Buscar status dos selecionados</button>
        </div>
      </details>
    </section>

    <!-- Direita -->
    <section class="card">
      <h2>Perfis da planilha</h2>

      <div class="toolbar">
        <input id="search" type="text" placeholder="Pesquisar por nome ou #id..." />
        <select id="sortMode">
          <option value="total_desc">Ordenar: Total ↓</option>
          <option value="total_asc">Ordenar: Total ↑</option>
          <option value="name_asc">Ordenar: Nome A → Z</option>
          <option value="name_desc">Ordenar: Nome Z → A</option>
        </select>
      </div>

      <div id="profilesList" class="list" style="min-height: 120px;"></div>
      <p class="small" id="profilesCount"></p>

      <div class="divider"></div>
      <h2>Status dos selecionados</h2>
      <div id="results" class="grid"></div>
      <p id="statusMessage" class="loading"></p>
    </section>
  </main>

  <script>
    // Estado
    const state = {
      rawRows: [],
      columns: [],
      mappings: { id: null, name: null, total: null },
      profiles: [], // [{id, name, total}]
      selectedIds: new Set(),
      searchTerm: '',
      sortMode: 'total_desc',
    };

    // --- CSV robusto (suporta campos com aspas e vírgulas internas) ---

    // Detecta delimitador (preferência por ';' se existir na header; senão ',')
    function detectDelimiter(headerLine) {
      return headerLine.includes(';') ? ';' : ',';
    }

    // Split de uma linha CSV respeitando aspas e aspas-escapadas ("")
    function splitCsvLine(line, delim) {
      const out = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') { // aspas escapada
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === delim && !inQuotes) {
          out.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    // Parser CSV
    function parseCSV(text) {
      const lines = text.replace(/\r/g, '').split('\n').filter(l => l.length > 0);
      if (lines.length === 0) return [];
      const delim = detectDelimiter(lines[0]);

      const headers = splitCsvLine(lines[0], delim).map(h => h.trim());
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const rawCols = splitCsvLine(lines[i], delim);
        const cols = rawCols.map(v => {
          let val = v.trim();
          if (val.startsWith('"') && val.endsWith('"')) {
            val = val.slice(1, -1).replace(/""/g, '"');
          }
          return val;
        });

        const obj = {};
        headers.forEach((h, idx) => { obj[h] = (cols[idx] ?? '').trim(); });
        rows.push(obj);
      }
      return { headers, rows };
    }

    // UI refs
    const csvUrl = document.getElementById('csvUrl');
    const csvText = document.getElementById('csvText');
    const btnFetchCsv = document.getElementById('btnFetchCsv');
    const btnParseCsv = document.getElementById('btnParseCsv');
    const btnClearCsv = document.getElementById('btnClearCsv');
    const colId = document.getElementById('colId');
    const colName = document.getElementById('colName');
    const colTotal = document.getElementById('colTotal');
    const btnBuildList = document.getElementById('btnBuildList');
    const profilesList = document.getElementById('profilesList');
    const profilesCount = document.getElementById('profilesCount');
    const shortlist = document.getElementById('shortlist');
    const apiKey = document.getElementById('apiKey');
    const btnFetchSelected = document.getElementById('btnFetchSelected');
    const results = document.getElementById('results');
    const statusMessage = document.getElementById('statusMessage');
    const search = document.getElementById('search');
    const sortMode = document.getElementById('sortMode');

    // Mapping automático
    function fillMappingSelectors(headers) {
      [colId, colName, colTotal].forEach(sel => sel.innerHTML = '');
      for (const h of headers) {
        for (const sel of [colId, colName, colTotal]) {
          const o = document.createElement('option'); o.value = h; o.textContent = h; sel.appendChild(o);
        }
      }
      const idGuess = headers.find(h => /^(id|xid|player_id|userid|user_id)$/i.test(h)) || headers[0];
      const nameGuess = headers.find(h => /^(member|name|nome|player|username|user|nick)$/i.test(h)) || headers[1] || headers[0];
      const totalGuess = headers.find(h => /^(total|stats|total_stats)$/i.test(h)) || headers[2] || headers[0];
      colId.value = idGuess; colName.value = nameGuess; colTotal.value = totalGuess;
      state.mappings.id = idGuess; state.mappings.name = nameGuess; state.mappings.total = totalGuess;
      btnBuildList.disabled = false;
    }

    // Utils de número
    function normalizeNumber(val){
      if (val === undefined || val === null) return 0;
      // remove separadores comuns (pontos/vírgulas/espaços)
      const num = String(val).replace(/\./g,'').replace(/,/g,'').replace(/\s/g,'');
      const n = Number(num);
      return Number.isFinite(n) ? n : 0;
    }
    function formatNumber(val){
      const n = normalizeNumber(val);
      return n.toLocaleString('en-US');
    }

    function getFilteredSortedProfiles(){
      const q = state.searchTerm.trim().toLowerCase();
      let arr = [...state.profiles];
      if (q) arr = arr.filter(p => (p.name||'').toLowerCase().includes(q) || String(p.id).includes(q));
      switch(state.sortMode){
        case 'total_asc':  arr.sort((a,b)=> normalizeNumber(a.total) - normalizeNumber(b.total)); break;
        case 'name_asc':   arr.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); break;
        case 'name_desc':  arr.sort((a,b)=> (b.name||'').localeCompare(a.name||'')); break;
        case 'total_desc':
        default:           arr.sort((a,b)=> normalizeNumber(b.total) - normalizeNumber(a.total));
      }
      return arr;
    }

    // Render da lista
    function renderProfiles() {
      profilesList.innerHTML = '';
      const data = getFilteredSortedProfiles();
      for (const p of data) {
        const el = document.createElement('div');
        el.className = 'item';
        const left = document.createElement('div');
        left.className = 'meta';

        const title = document.createElement('div');
        title.innerHTML = `<b>${escapeHtml(p.name || '(sem nome)')}</b> <span class="small">#${p.id}</span>`;
        const link = document.createElement('a');
        link.href = `https://www.torn.com/profiles.php?XID=${encodeURIComponent(p.id)}`;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = 'Abrir perfil';

        const total = document.createElement('div');
        total.innerHTML = `<span class="pill">Total</span> <span class="small">${formatNumber(p.total)}</span>`;

        left.appendChild(title);
        left.appendChild(link);
        left.appendChild(total);

        const right = document.createElement('div');
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = state.selectedIds.has(p.id);
        cb.addEventListener('change', () => {
          if (cb.checked) { state.selectedIds.add(p.id); addToShortlist(p); }
          else { state.selectedIds.delete(p.id); removeFromShortlist(p.id); }
          btnFetchSelected.disabled = state.selectedIds.size === 0;
        });
        right.appendChild(cb);

        el.appendChild(left); el.appendChild(right);
        profilesList.appendChild(el);
      }
      profilesCount.textContent = `${data.length} perfil(is) exibido(s). Total carregado: ${state.profiles.length}.`;
    }

    // Shortlist
    function addToShortlist(p) {
      if (document.getElementById('short-' + p.id)) return;
      const el = document.createElement('div');
      el.className = 'item'; el.id = 'short-' + p.id;
      const left = document.createElement('div'); left.className = 'meta';
      left.innerHTML = `<b>${escapeHtml(p.name || '(sem nome)')}</b> <span class="small">#${p.id}</span> <div class="small">Total: ${formatNumber(p.total)}</div>`;
      const right = document.createElement('div');
      const rm = document.createElement('button'); rm.className = 'btn ghost'; rm.textContent = 'Remover';
      rm.addEventListener('click', () => {
        state.selectedIds.delete(p.id);
        const chk = [...profilesList.querySelectorAll('input[type="checkbox"]')]
          .find(x => x.closest('.item').querySelector('.small')?.textContent === '#' + p.id);
        if (chk) chk.checked = false;
        el.remove();
        btnFetchSelected.disabled = state.selectedIds.size === 0;
      });
      right.appendChild(rm);
      el.appendChild(left); el.appendChild(right);
      shortlist.appendChild(el);
    }
    function removeFromShortlist(id) {
      const el = document.getElementById('short-' + id); if (el) el.remove();
    }

    // Torn API
    async function fetchTornUser(id, key) {
      const url = `https://api.torn.com/user/${encodeURIComponent(id)}?selections=profile,basic&key=${encodeURIComponent(key)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Falha ao consultar ${id}: HTTP ${res.status}`);
      const data = await res.json();
      if (data.error) throw new Error(`Erro API ${id}: ${data.error.error} (code ${data.error.code})`);
      return data;
    }

    function renderResultCard(player, data) {
      const card = document.createElement('div');
      card.className = 'stat';
      const lifeCur = data?.life?.current ?? '-';
      const lifeMax = data?.life?.maximum ?? '-';
      const stState = data?.status?.state ?? '-';
      const stDesc = data?.status?.description ?? '-';
      const laStatus = data?.last_action?.status ?? '-';
      const laRel = data?.last_action?.relative ?? '-';

      const hpPct = (Number(lifeCur) && Number(lifeMax)) ? Math.round((lifeCur / lifeMax) * 100) : null;
      const hpStr = hpPct !== null ? `${lifeCur} / ${lifeMax} (${hpPct}%)` : `${lifeCur} / ${lifeMax}`;

      card.innerHTML = `
        <h3>${escapeHtml(player.name || '(sem nome)')} <span class="muted">#${player.id}</span></h3>
        <div class="muted">Perfil: <a href="https://www.torn.com/profiles.php?XID=${encodeURIComponent(player.id)}" target="_blank" rel="noopener">abrir</a></div>
        <div class="divider" style="margin:8px 0"></div>
        <div><span class="badge">Total</span> ${formatNumber(player.total)}</div>
        <div><span class="badge">Vida</span> ${hpStr}</div>
        <div><span class="badge">Status</span> ${escapeHtml(stState)}${stDesc ? ` — <span class="muted">${escapeHtml(stDesc)}</span>` : ''}</div>
        <div><span class="badge">Última ação</span> ${escapeHtml(laStatus)} <span class="muted">(${escapeHtml(laRel)})</span></div>
      `;
      results.appendChild(card);
    }

    // Handlers (baixar/ler/limpar)
    btnFetchCsv.addEventListener('click', async () => {
      const url = csvUrl.value.trim();
      if (!url) { alert('Informe um URL CSV publicado, ou cole os dados.'); return; }
      btnFetchCsv.disabled = true; btnFetchCsv.textContent = 'Baixando...';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        csvText.value = text;
      } catch (e) {
        alert('Falha ao baixar CSV: ' + e.message);
      } finally { btnFetchCsv.disabled = false; btnFetchCsv.textContent = 'Buscar CSV'; }
    });

    btnParseCsv.addEventListener('click', () => {
      const text = csvText.value.trim();
      if (!text) { alert('Cole o CSV ou forneça o URL.'); return; }
      const parsed = parseCSV(text);
      if (!parsed.headers || parsed.headers.length === 0 || parsed.rows.length === 0) {
        alert('Não foi possível ler o CSV. Verifique o cabeçalho e os dados.'); return;
      }
      state.rawRows = parsed.rows;
      state.columns = parsed.headers;
      fillMappingSelectors(parsed.headers);
      alert('CSV carregado! Agora mapeie as colunas e clique em "Construir lista de perfis".');
    });

    btnClearCsv.addEventListener('click', () => {
      csvUrl.value = ''; csvText.value = ''; profilesList.innerHTML = ''; results.innerHTML = ''; shortlist.innerHTML='';
      profilesCount.textContent = ''; state.rawRows = []; state.columns = []; state.profiles = []; state.selectedIds.clear();
      btnBuildList.disabled = true; btnFetchSelected.disabled = true; statusMessage.textContent='';
      [colId, colName, colTotal].forEach(sel => sel.innerHTML = '');
      search.value=''; state.searchTerm=''; sortMode.value='total_desc'; state.sortMode='total_desc';
    });

    colId.addEventListener('change', () => state.mappings.id = colId.value);
    colName.addEventListener('change', () => state.mappings.name = colName.value);
    colTotal.addEventListener('change', () => state.mappings.total = colTotal.value);

    btnBuildList.addEventListener('click', () => {
      const idKey = state.mappings.id; const nameKey = state.mappings.name; const totalKey = state.mappings.total;
      if (!idKey || !nameKey || !totalKey) { alert('Selecione as colunas de ID, Nome e Total.'); return; }
      const items = [];
      for (const r of state.rawRows) {
        const id = String(r[idKey] ?? '').trim();
        if (!id || !/^\d+$/.test(id)) continue;
        const name = String(r[nameKey] ?? '').trim();
        const total = r[totalKey];
        items.push({ id, name, total });
      }
      state.profiles = items;
      state.selectedIds.clear(); shortlist.innerHTML='';
      renderProfiles();
      btnFetchSelected.disabled = true;
    });

    btnFetchSelected.addEventListener('click', async () => {
      const key = apiKey.value.trim();
      if (!key) { alert('Cole sua chave da API Torn.'); return; }
      const ids = [...state.selectedIds];
      if (ids.length === 0) { alert('Selecione ao menos um perfil.'); return; }
      results.innerHTML='';
      statusMessage.textContent = `Buscando ${ids.length} usuário(s)...`;
      statusMessage.classList.add('is-loading');   // <- spinner LIGADO

      try {
        for (const id of ids) {
          const player = state.profiles.find(p => p.id === id) || { id, name: '', total: 0 };
          try {
            const data = await fetchTornUser(id, key);
            renderResultCard(player, data);
          } catch (e) {
            const errCard = document.createElement('div');
            errCard.className = 'stat';
            errCard.innerHTML = `<h3>${escapeHtml(player.name || '(sem nome)')} <span class="muted">#${player.id}</span></h3>
            <div class="danger">Erro ao buscar: ${escapeHtml(e.message)}</div>`;
            results.appendChild(errCard);
          }
        }
      } finally {
        statusMessage.textContent = 'Concluído.';
        statusMessage.classList.remove('is-loading'); // <- spinner DESLIGADO
      }
    });

    // Busca + Ordenação
    search.addEventListener('input', () => {
      state.searchTerm = search.value;
      renderProfiles();
    });
    sortMode.addEventListener('change', () => {
      state.sortMode = sortMode.value;
      renderProfiles();
    });

    // Clique no item para alternar seleção (exceto links/botões/checkbox)
    profilesList.addEventListener('click', (ev) => {
      const item = ev.target.closest('.item');
      if (!item) return;
      if (['INPUT','A','BUTTON','SELECT','TEXTAREA'].includes(ev.target.tagName)) return;
      const idText = item.querySelector('.small')?.textContent || '';
      const id = idText.replace('#','');
      const name = item.querySelector('b')?.textContent || '';
      const totalText = item.querySelector('.pill')?.nextSibling?.textContent || '';
      const total = (totalText || '').trim();
      const cb = item.querySelector('input[type="checkbox"]');
      if (cb) cb.checked = !cb.checked;
      const p = { id, name, total };
      if (cb.checked) { state.selectedIds.add(id); addToShortlist(p); }
      else { state.selectedIds.delete(id); removeFromShortlist(id); }
      btnFetchSelected.disabled = state.selectedIds.size === 0;
    });

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }
  </script>
</body>
</html>
